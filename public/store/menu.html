<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="menu.css">
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyBzWGqNmb6KazuZB_ykjg1zkS-YWSaFFBk",
            authDomain: "store-reservation-system.firebaseapp.com",
            projectId: "store-reservation-system",
            storageBucket: "store-reservation-system.appspot.com",
            messagingSenderId: "734537126957",
            appId: "1:734537126957:web:5d84d462476d77ddbbd4a4"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
    <title>Document</title>
</head>

<body>
    <!--오프캔버스 레프트 사이드 메뉴바-->
    <div class="offcanvas offcanvas-start show" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1"
        id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel" style="width:15%;background-color: #d0a9fe">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasScrollingLabel">메뉴</h5>
        </div>
        <div class="offcanvas-body">
            <div style="cursor:pointer;" onclick="$('#offcanvasBottom').offcanvas('show')">
                <hr style="height:2px">
                <p>메뉴추가</p>
            </div>
            <div style="cursor:pointer;" onclick="alert('메뉴 수정 또는 삭제를 원하시면 해당 메뉴를 클릭하세요.')">
                <hr style="height:2px">
                <p>메뉴 수정 & 삭제</p>
            </div>
            <div style="cursor:pointer;" onclick="window.location.href='store_reservation_state.html'">
                <hr style="height:2px">
                <p>예약현황</p>
            </div>
            <div style="cursor:pointer;" onclick="logout()">
                <hr style="height:2px">
                <p>로그아웃</p>
                <hr style="height:2px">
            </div>
        </div>
    </div>
    <!--오프캔버스 레프트 사이드 메뉴바-->

    <!--오프캔버스 바텀 메뉴 추가 화면-->
    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasBottom" aria-labelledby="offcanvasBottomLabel"
        style="height:100%;background-color: beige;">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasBottomLabel">메뉴추가</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div style="text-align:center;font-size: 3em;margin-bottom:2%">메뉴추가</div>
            <hr style="height:2px">
            <div style="display:flex;margin:0 auto;">
                <div class="container mt-3"
                    style="max-width:400px;max-height:300px;width:100%;height:100%;margin:0 auto;margin-right:0px">
                    <img src="dummy_image.jpeg"
                        style="max-width:400px;max-height:200px;width:100%;height:100%;margin-bottom:10px;border: 1px solid gainsboro"
                        id="img_section">
                    <div class="mb-3">
                        <input class="form-control" type="file" id="upload_file">
                    </div>
                </div>
                <div class="container mt-3"
                    style="max-width:300px;max-height:200px;width:100%;height:100%;margin:0 auto; margin-left:0px;">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="menu_title" placeholder="매장명">
                        <label for="floatingInput">메뉴명</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="menu_price" placeholder="매장명">
                        <label for="floatingInput">메뉴가격</label>
                    </div>
                    <div class="form-floating" style="margin-bottom:15px">
                        <textarea class="form-control" placeholder="Leave a comment here" id="menu_info"
                            style="height: 100px"></textarea>
                        <label for="floatingTextarea2">메뉴정보</label>
                    </div>
                    <div style="float:right">
                        <button type="button" class="btn btn-success btn-lg" id="menu_registration">등록</button>
                        <button type="button" class="btn btn-danger btn-lg" id="offcanvas-bottom-cancle">취소</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--오프캔버스 바텀 메뉴 추가 화면-->

    <!--오프캔버스 라이트 메뉴 수정 또는 삭제 화면-->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel"
        style="width:100%;background-color: beige;">
        <div class="offcanvas-header">
            <h5 id="offcanvasRightLabel">메뉴 수정 & 삭제</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div style="text-align:center;font-size: 3em;margin-bottom:2%">메뉴 수정 또는 삭제</div>
            <hr style="height:2px">
            <div style="display:flex;margin:0 auto;">
                <div class="container mt-3"
                    style="max-width:400px;max-height:300px;width:100%;height:100%;margin:0 auto;margin-right:0px;">
                    <img src="dummy_image.jpeg"
                        style="max-width:400px;max-height:200px;width:100%;height:100%;margin-bottom:10px;border: 1px solid gainsboro"
                        id="modifyORdelete-img">
                    <div class="mb-3">
                        <input class="form-control" type="file" id="modifyORdelete-upload_file">
                    </div>
                </div>
                <div class="container mt-3"
                    style="max-width:300px;max-height:200px;width:100%;height:100%;margin:0 auto; margin-left:0px;">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="modifyORdelete-menu_title" placeholder="매장명">
                        <label for="floatingInput">메뉴명</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="modifyORdelete-menu_price" placeholder="매장명">
                        <label for="floatingInput">메뉴가격</label>
                    </div>
                    <div class="form-floating" style="margin-bottom:15px">
                        <textarea class="form-control" placeholder="Leave a comment here" id="modifyORdelete-menu_info"
                            style="height: 100px"></textarea>
                        <label for="floatingTextarea2">메뉴정보</label>
                    </div>
                    <div style="float:right">
                        <button type="button" class="btn btn-success" id="menu_modify">수정</button>
                        <button type="button" class="btn btn-danger" id="menu_delete">삭제</button>
                        <button type="button" class="btn btn-warning" id="offcanvas-right-cancle">취소</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--오프캔버스 라이트 메뉴 수정 또는 삭제 화면-->

    <!--기본 메뉴페이지 화면-->
    <div style="text-align:center;font-size: 3em;margin-top:5%;margin-bottom:2%">메뉴</div>
        <div class="container mt-3" id="content-body">
        </div>
    </div>
    <script>
        const db = firebase.firestore();

        db.collection("매장").doc(localStorage.getItem("entrepreneur_uid")).collection("메뉴정보").get().then((result) => {
            result.forEach((doc) => {
                var templete =
                    `<div class="menu" onclick="menu_modify_or_delete('${doc.data().메뉴사진}','${doc.data().메뉴명}','${doc.data().메뉴가격}','${doc.data().메뉴정보}','${doc.id}')">
                     <div class="thumbnail" style="background-image: url('${doc.data().메뉴사진}')"></div>
                     <div class="flex-grow-1 p-4">
                     <h5 class="menu_title">${doc.data().메뉴명}</h5>
                     <p class="menu_info">${doc.data().메뉴정보}</p>
                     <p class="menu_price">${doc.data().메뉴가격}원</p>
                     </div>
                     </div>`;
                $("#content-body").append(templete);
            })
        })
    </script>
    <!--기본 메뉴페이지 화면-->

    <!--오프캔버스 바텀 메뉴 추가 화면-->
    <script>
        const storage = firebase.storage();
        const storageRef = storage.ref();
        const reader = new FileReader();
        var imgFile;

        reader.onload = (readerEvent) => {
            $("#img_section").attr("src", readerEvent.target.result);
        };

        $("#upload_file").change(function (changeEvent) {
            imgFile = changeEvent.target.files[0];
            reader.readAsDataURL(imgFile);
        })

        $("#menu_registration").click(function () {
            var path = storageRef.child(localStorage.getItem("entrepreneur_uid") + "/메뉴이미지/" + imgFile.name);
            var upload = path.put(imgFile);

            upload.on("state_changed",
                // 변화시 동작하는 함수 
                null,
                //에러시 동작하는 함수
                (error) => {
                    console.error(error);
                },
                // 성공시 동작하는 함수
                () => {
                    upload.snapshot.ref.getDownloadURL().then((url) => {
                        var add_menu = {
                            메뉴가격: parseInt($("#menu_price").val()),
                            메뉴명: $("#menu_title").val(),
                            메뉴사진: url,
                            메뉴정보: $("#menu_info").val()
                        }
                        db.collection("매장").doc(localStorage.getItem("entrepreneur_uid")).collection("메뉴정보").add(add_menu).then(() => {
                            alert("메뉴 등록이 완료되었습니다.");
                            window.location.href = "menu.html";
                        }).catch((err) => {
                            alert(err.code);
                        })
                    });
                }
            );
        })

        $("#offcanvas-bottom-cancle").click(function () {
            $("#offcanvasBottom").offcanvas("hide");
        })
    </script>
    <!--오프캔버스 바텀 메뉴 추가 화면-->

    <!--오프캔버스 라이트 메뉴 수정 또는 삭제 화면-->
    <script>
        function menu_modify_or_delete(menu_img, menu_title, menu_price, menu_info, menu_id) {
            const db = firebase.firestore();
            const storage = firebase.storage();
            const storageRef = storage.ref();
            const reader = new FileReader();
            var imgFile;

            $("#offcanvasRight").offcanvas("show");
            $("#modifyORdelete-img").attr("src", menu_img);
            $("#modifyORdelete-menu_title").attr("value", menu_title);
            $("#modifyORdelete-menu_price").attr("value", menu_price);
            $("#modifyORdelete-menu_info").html(menu_info);

            reader.onload = (readerEvent) => {
                $("#modifyORdelete-img").attr("src", readerEvent.target.result);
            };

            $("#modifyORdelete-upload_file").change(function (changeEvent) {
                imgFile = changeEvent.target.files[0];
                reader.readAsDataURL(imgFile);
            })

            $("#menu_modify").click(function () {
                if (imgFile != undefined) {
                    var path = storageRef.child(localStorage.getItem("entrepreneur_uid") + "/메뉴이미지/" + imgFile.name);
                    var upload = path.put(imgFile);
                    var storageRef_remove = storage.refFromURL(menu_img);
                    storageRef_remove.delete().then(() => {
                        upload.on("state_changed",
                            // 변화시 동작하는 함수 
                            null,
                            //에러시 동작하는 함수
                            (error) => {
                                console.error(error);
                            },
                            // 성공시 동작하는 함수
                            () => {
                                upload.snapshot.ref.getDownloadURL().then((url) => {
                                    var menu_modify = {
                                        메뉴명: $("#modifyORdelete-menu_title").val(),
                                        메뉴가격: parseInt($("#modifyORdelete-menu_price").val()),
                                        메뉴정보: $("#modifyORdelete-menu_info").val(),
                                        메뉴사진: url
                                    }
                                    db.collection("매장").doc(localStorage.getItem("entrepreneur_uid")).collection("메뉴정보").doc(menu_id).update(menu_modify).then(() => {
                                        alert("메뉴 수정이 완료되었습니다.");
                                        window.location.href = "menu.html";
                                    }).catch((err) => {
                                        console.log(err);
                                    });
                                });
                            }
                        );
                    }).catch((error) => {
                        alert(error);
                    })
                } else {
                    var menu_modify = {
                        메뉴명: $("#modifyORdelete-menu_title").val(),
                        메뉴가격: parseInt($("#modifyORdelete-menu_price").val()),
                        메뉴정보: $("#modifyORdelete-menu_info").val(),
                    }
                    db.collection("매장").doc(localStorage.getItem("entrepreneur_uid")).collection("메뉴정보").doc(menu_id).update(menu_modify).then(() => {
                        alert("메뉴 수정이 완료되었습니다.");
                        window.location.href = "menu.html";
                    }).catch((err) => {
                        console.log(err);
                    });
                }
            })

            $("#menu_delete").click(function () {
                var storageRef_remove = storage.refFromURL(menu_img);

                if (confirm("이 메뉴를 삭제하시겠습니까?")) {
                    storageRef_remove.delete().then(() => {
                        db.collection("매장").doc(localStorage.getItem("entrepreneur_uid")).collection("메뉴정보").doc(menu_id).delete().then(() => {
                            alert("메뉴가 삭제되었습니다.");
                            window.location.href = "menu.html";
                        }).catch((err) => {
                            console.log(err);
                        });
                    }).catch((error) => {
                        alert(error);
                    })
                } else {

                }
            })

            $("#offcanvas-right-cancle").click(function () {
                $('#offcanvasRight').offcanvas('hide');
            })
        }
    </script>
    <!--오프캔버스 라이트 메뉴 수정 또는 삭제 화면-->

    <script>
        function logout() {
            firebase.auth().signOut().then(() => {
                window.location.href = "login.html";
            });
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
</body>

</html>